<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Pillar: Your Daily Foundation v2.1</title>
    <link href="styles.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles */
        :root {
            --journal-color: #f59e0b; /* amber-500 */
            --stretch-color: #84cc16; /* lime-500 */
            --strength-color: #ef4444; /* red-500 */
            --meditate-color: #6366f1; /* indigo-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            transition: background-color 0.5s ease;
        }

        .pillar-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid transparent;
        }
        .pillar-card:hover:not(.completed) {
             transform: translateY(-5px);
             box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .pillar-card.completed {
            background: rgba(240, 253, 244, 0.8); /* green-50 with opacity */
        }
        #pillar-journal { border-left-color: var(--journal-color); }
        #pillar-stretch { border-left-color: var(--stretch-color); }
        #pillar-strength { border-left-color: var(--strength-color); }
        #pillar-meditate { border-left-color: var(--meditate-color); }

        .btn-primary {
            transition: all 0.3s ease;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-overlay.hidden {
            visibility: hidden;
            display: none;
        }
        
        .modal-overlay:not(.hidden) {
            display: flex;
        }
        #activity-modal-content {
            transform: translateY(20px);
            transition: transform 0.3s ease-in-out;
        }
        

        .modal-overlay.visible #activity-modal-content {
            transform: translateY(0);
        }
        
        /* Ensure textarea is properly sized */
        #journal-textarea {
            min-height: 200px;
            font-family: inherit;
            line-height: 1.5;
        }
        
        /* Ensure modal content is properly visible */
        #activity-modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            max-width: 48rem;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .progress-circle {
            transform: rotate(-90deg);
        }
        .progress-circle-bar {
            transition: stroke-dashoffset 1s linear;
        }
        .completion-check {
            transform: scale(0);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .pillar-card.completed .completion-check {
            transform: scale(1);
        }
        .main-progress-bar {
            transition: width 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Main Container -->
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-slate-900">Pillar</h1>
            <p class="text-lg text-slate-600 mt-2">Your Daily Foundation for Mind & Body.</p>
        </header>

        <!-- Main Content: Pillar Journey -->
        <main id="main-journey">
            <h2 id="dynamic-greeting" class="text-2xl font-semibold mb-4 text-center">Good Morning.</h2>
            <p class="text-center text-slate-500 mb-6">Choose an activity to begin your day.</p>
            
            <!-- Overall Progress Bar -->
            <div class="w-full bg-white/50 rounded-full h-2.5 mb-8 shadow-inner">
                <div id="main-progress-bar" class="bg-gradient-to-r from-green-400 to-blue-500 h-2.5 rounded-full main-progress-bar" style="width: 0%"></div>
            </div>

            <div class="space-y-6">
                <!-- Pillar 1: Journal -->
                <div id="pillar-journal" class="pillar-card bg-white p-6 rounded-lg shadow-sm" onclick="showPillarOptions('journal')" tabindex="0">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-semibold">1. The Warm-Up: Journal</h3>
                            <p class="text-slate-500">3-5 minutes</p>
                        </div>
                        <div id="journal-status" class="text-2xl completion-check">✅</div>
                    </div>
                </div>

                <!-- Pillar 2: Stretch -->
                <div id="pillar-stretch" class="pillar-card bg-white p-6 rounded-lg shadow-sm" onclick="showPillarOptions('stretch')" tabindex="0">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-semibold">2. The Flow: Stretch</h3>
                            <p class="text-slate-500">10 minutes</p>
                        </div>
                         <div id="stretch-status" class="text-2xl completion-check">✅</div>
                    </div>
                </div>

                <!-- Pillar 3: Full Body -->
                <div id="pillar-strength" class="pillar-card bg-white p-6 rounded-lg shadow-sm" onclick="showPillarOptions('strength')" tabindex="0">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-semibold">3. The Work: Full Body</h3>
                            <p class="text-slate-500">14 minutes</p>
                        </div>
                         <div id="strength-status" class="text-2xl completion-check">✅</div>
                    </div>
                </div>

                <!-- Pillar 4: Meditate -->
                <div id="pillar-meditate" class="pillar-card bg-white p-6 rounded-lg shadow-sm" onclick="showPillarOptions('meditate')" tabindex="0">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-semibold">4. The Cool-Down: Meditate</h3>
                            <p class="text-slate-500">12 minutes</p>
                        </div>
                         <div id="meditate-status" class="text-2xl completion-check">✅</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Activity Modal -->
        <div id="activity-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4 hidden" role="dialog" aria-modal="true">
            <div id="activity-modal-content" class="bg-white rounded-lg shadow-xl p-3 sm:p-4 md:p-6 max-w-lg sm:max-w-2xl w-full max-h-[75vh] overflow-y-auto relative">
                <!-- Content is injected here by JavaScript -->
            </div>
        </div>
        

        
        <!-- Hidden elements to ensure Tailwind includes all needed classes -->
        <div class="hidden">
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4"></div>
            <div class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-3xl font-light"></div>
            <div class="hover:text-slate-600"></div>
            <div class="hover:bg-slate-200"></div>
            <div class="hover:text-slate-600"></div>
            <div class="text-2xl font-bold mb-4"></div>
            <div class="text-slate-600 mb-6"></div>
            <div class="flex items-center justify-between mb-6"></div>
            <div class="flex-1"></div>
            <div class="ml-4 px-3 py-1 text-sm bg-slate-100 hover:bg-slate-200 rounded-md transition-colors"></div>
            <div class="w-full h-48 border border-slate-300 rounded-md p-4 focus:ring-2 focus:ring-blue-500"></div>
            <div class="w-full h-64 border border-slate-300 rounded-md p-4 focus:ring-2 focus:ring-blue-500 resize-none"></div>
            <div class="h-32 sm:h-40"></div>
            <div class="w-32 h-32 sm:w-40 sm:h-40"></div>
            <div class="text-2xl sm:text-3xl"></div>
            <div class="text-6xl sm:text-8xl"></div>
            <div class="w-32 h-32 sm:w-40 sm:h-40 md:w-48 md:h-48"></div>
            <div class="text-2xl sm:text-3xl md:text-4xl"></div>
            <div class="mb-4 sm:mb-6"></div>
            <div class="gap-4 sm:gap-8"></div>
            <div class="h-6 w-6 sm:h-8 sm:w-8"></div>
            <div class="h-20 sm:h-24"></div>
            <div class="w-24 h-24 sm:w-28 sm:h-28"></div>
            <div class="text-xl sm:text-2xl"></div>
            <div class="text-4xl sm:text-6xl"></div>
            <div class="text-xs"></div>
            <div class="h-4 w-4 sm:h-6 sm:w-6"></div>
            <div class="gap-2 sm:gap-4"></div>
            <div class="max-w-lg"></div>
            <div class="max-h-[75vh]"></div>
            <div class="mt-6 flex justify-end"></div>
            <div class="btn-primary px-6 py-2 rounded-md font-semibold"></div>
            <div class="aspect-w-16 aspect-h-9 bg-black rounded-lg overflow-hidden mb-4"></div>
            <div class="w-full h-full"></div>
            <div class="text-center"></div>
            <div class="text-sm font-semibold text-blue-600 uppercase"></div>
            <div class="text-3xl font-bold mt-2 mb-2"></div>
            <div class="w-full h-48 flex items-center justify-center my-4 text-8xl"></div>
            <div class="text-slate-500 mb-6 h-12"></div>
            <div class="relative w-40 h-40 mx-auto mb-6"></div>
            <div class="w-full h-full progress-circle"></div>
            <div class="text-slate-200"></div>
            <div class="text-blue-600 progress-circle-bar"></div>
            <div class="absolute inset-0 flex items-center justify-center text-4xl font-bold text-slate-800"></div>
            <div class="text-slate-500 mb-6"></div>
            <div class="flex items-center justify-center gap-8"></div>
            <div class="text-slate-400 hover:text-slate-600 transition-colors p-2 rounded-full"></div>
            <div class="h-8 w-8"></div>
            <div class="text-8xl font-bold text-blue-600"></div>
            <div class="text-slate-600 mb-8"></div>
            <div class="relative w-48 h-48 mx-auto mb-8"></div>
            <div class="animate-pulse absolute inset-0 bg-blue-100 rounded-full"></div>
            <div class="absolute inset-0 flex items-center justify-center"></div>
            <div class="text-4xl font-bold text-slate-800"></div>
        </div>

    </div>

    <script>
        // --- State Management ---
        const state = {
            pillars: {
                journal: { completed: false },
                stretch: { completed: false },
                strength: { completed: false },
                meditate: { completed: false },
            },
            journalEntry: '',
            journalPrompts: [
                // Monday - Energy & Intentions
                "What is one thing I am looking forward to today?",
                "What's a small, achievable goal I can accomplish today?",
                "Describe something that made you smile yesterday.",
                "What is one thing I can do today that my future self will thank me for?",
                "If I had an extra hour today, how would I spend it?",
                "What's a challenge I'm facing, and what's one small step I can take to address it?",
                "Who is someone I'm grateful for, and why?",
                
                // Additional prompts for variety
                "What would make today feel like a success?",
                "What's something I'm curious about learning today?",
                "How can I be kinder to myself today?",
                "What's one thing I want to let go of today?",
                "What's a small act of kindness I can do for someone else?",
                "What's something I'm proud of from yesterday?",
                "What's one thing I can do to improve my mood today?",
                "What's a boundary I need to set today?",
                "What's something I'm looking forward to this week?",
                "How can I make today more enjoyable?",
                "What's one thing I can do to take care of my body today?",
                "What's a thought or worry I can release today?",
                "What's something I'm excited to create or accomplish?",
                "How can I be more present today?",
                "What's one thing I can do to connect with someone today?",
                "What's a habit I want to strengthen today?",
                "What's something I can do to make my space more comfortable?",
                "What's one thing I can do to challenge myself today?",
                "How can I be more patient with myself today?",
                "What's something I can do to express gratitude today?",
                "What's one thing I can do to reduce stress today?",
                "What's a skill I want to practice today?",
                "How can I be more authentic today?",
                "What's something I can do to boost my confidence today?",
                "What's one thing I can do to be more organized today?",
                "What's a positive affirmation I need to hear today?",
                "What's something I can do to improve my relationships?",
                "What's one thing I can do to be more mindful today?",
                "What's a goal I want to work toward this month?",
                "How can I be more compassionate toward others today?",
                "What's something I can do to improve my sleep tonight?",
                "What's one thing I can do to be more creative today?",
                "What's a fear I want to face today?",
                "How can I be more generous with my time today?",
                "What's something I can do to improve my focus today?",
                "What's one thing I can do to be more courageous today?",
                "What's a lesson I learned recently that I want to apply today?",
                "How can I be more grateful for the small things today?",
                "What's something I can do to improve my communication?",
                "What's one thing I can do to be more disciplined today?",
                "What's a dream or aspiration I want to work toward?",
                "How can I be more understanding of others today?",
                "What's something I can do to improve my mental clarity?",
                "What's one thing I can do to be more adventurous today?",
                "What's a value that's important to me that I want to honor today?",
                "How can I be more supportive of others today?",
                "What's something I can do to improve my emotional well-being?",
                "What's one thing I can do to be more resilient today?",
                "What's a memory I want to create today?",
                "How can I be more accepting of what I can't control?",
                "What's something I can do to improve my physical health?",
                "What's one thing I can do to be more optimistic today?",
                "What's a relationship I want to nurture today?",
                "How can I be more forgiving of myself today?",
                "What's something I can do to improve my productivity?",
                "What's one thing I can do to be more empathetic today?",
                "What's a change I want to make in my life?",
                "How can I be more present with my loved ones today?",
                "What's something I can do to improve my self-care?",
                "What's one thing I can do to be more confident today?",
                "What's a skill I want to develop this year?",
                "How can I be more grateful for my challenges?",
                "What's something I can do to improve my environment?",
                "What's one thing I can do to be more patient today?",
                "What's a goal I want to set for next week?",
                "How can I be more loving toward myself today?",
                "What's something I can do to improve my mindset?",
                "What's one thing I can do to be more generous today?",
                "What's a truth I need to remember today?",
                "How can I be more open to new experiences?",
                "What's something I can do to improve my energy?",
                "What's one thing I can do to be more humble today?",
                "What's a strength I want to use today?",
                "How can I be more accepting of change?",
                "What's something I can do to improve my perspective?",
                "What's one thing I can do to be more determined today?",
                "What's a joy I want to experience today?",
                "How can I be more trusting of the process?",
                "What's something I can do to improve my intuition?",
                "What's one thing I can do to be more peaceful today?",
                "What's a connection I want to strengthen today?",
                "How can I be more accepting of imperfection?",
                "What's something I can do to improve my balance?",
                "What's one thing I can do to be more inspired today?",
                "What's a wisdom I want to share today?",
                "How can I be more accepting of uncertainty?",
                "What's something I can do to improve my flow?",
                "What's one thing I can do to be more authentic today?",
                "What's a light I want to shine today?",
                "How can I be more accepting of growth?",
                "What's something I can do to improve my harmony?",
                "What's one thing I can do to be more radiant today?",
                "What's a blessing I want to acknowledge today?",
                "How can I be more accepting of abundance?",
                "What's something I can do to improve my grace?",
                "What's one thing I can do to be more whole today?",
                "What's a gift I want to give today?",
                "How can I be more accepting of love?",
                "What's something I can do to improve my spirit?",
                "What's one thing I can do to be more complete today?",
                "What's a miracle I want to notice today?",
                "How can I be more accepting of beauty?",
                "What's something I can do to improve my essence?",
                "What's one thing I can do to be more alive today?",
                "What's a wonder I want to discover today?",
                "How can I be more accepting of magic?",
                "What's something I can do to improve my soul?",
                "What's one thing I can do to be more free today?",
                "What's a truth I want to embody today?",
                "How can I be more accepting of possibility?",
                "What's something I can do to improve my being?",
                "What's one thing I can do to be more me today?",
            ],
            strengthRoutine: [
                { name: 'Jumping Jacks', duration: 30, movement: 'A classic cardio move. Keep a brisk pace.', image: '✳️' },
                { name: 'Wall Sit', duration: 30, movement: 'Lean against a wall with knees at a 90-degree angle.', image: '🧱' },
                { name: 'Push-ups', duration: 30, movement: 'Perform standard push-ups. Modify on knees if necessary.', image: '🔽' },
                { name: 'Abdominal Crunch', duration: 30, movement: 'Lie on your back, knees bent, and lift your shoulders off the floor.', image: '🔥' },
                { name: 'Step-up onto Chair', duration: 30, movement: 'Step up onto a sturdy chair or bench, alternating legs.', image: '⬆️' },
                { name: 'Squat', duration: 30, movement: 'Keep your chest up and back straight as you lower your hips.', image: '⬇️' },
                { name: 'Triceps Dip on Chair', duration: 30, movement: 'With your back to a chair, place hands on the edge and lower your body.', image: '↘️' },
                { name: 'Plank', duration: 30, movement: 'Hold a straight line from head to heels, engaging your core.', image: '⏳' },
                { name: 'High Knees Running', duration: 30, movement: 'Run in place, bringing your knees up as high as possible.', image: '💨' },
                { name: 'Lunge', duration: 30, movement: 'Step forward and lower your hips until both knees are at 90 degrees. Alternate legs.', image: '➡️' },
                { name: 'Push-up and Rotation', duration: 30, movement: 'Perform a push-up, then rotate your body and extend one arm to the ceiling. Alternate sides.', image: '🔄' },
                { name: 'Side Plank', duration: 30, movement: 'Support your body on one forearm. Hold for 15s then switch sides.', image: '⏳' },
            ],
            currentPrompt: '',
            currentTimer: null,
            currentSequence: [],
            currentExerciseIndex: 0,
            lastFocusedElement: null,
        };

        // --- DOM Elements ---
        const activityModal = document.getElementById('activity-modal');
        const activityModalContent = document.getElementById('activity-modal-content');
        const mainProgressBar = document.getElementById('main-progress-bar');
        const dynamicGreeting = document.getElementById('dynamic-greeting');

        // --- Core Functions ---
        function init() {
            loadState();
            const today = new Date().toDateString();
            if (localStorage.getItem('lastVisit') !== today) {
                resetDailyProgress();
                localStorage.setItem('lastVisit', today);
            }
            // Randomly select a prompt for more variety
            const randomIndex = Math.floor(Math.random() * state.journalPrompts.length);
            state.currentPrompt = state.journalPrompts[randomIndex];
            updateDynamicGreeting();
            updateUI();
            addKeyboardListeners();
        }

        function updateUI() {
            let completedCount = 0;
            Object.keys(state.pillars).forEach(pillarKey => {
                const pillar = state.pillars[pillarKey];
                const pillarEl = document.getElementById(`pillar-${pillarKey}`);
                
                pillarEl.classList.toggle('completed', pillar.completed);
                if (pillar.completed) completedCount++;
            });
            const progressPercentage = (completedCount / 4) * 100;
            mainProgressBar.style.width = `${progressPercentage}%`;
        }
        
        function showPillarOptions(pillarKey) {
            if (state.pillars[pillarKey].completed) {
                if (confirm('You have already completed this. Do you want to do it again?')) {
                    state.pillars[pillarKey].completed = false;
                    updateUI();
                } else {
                    return;
                }
            }
            
            state.lastFocusedElement = document.activeElement;

            switch(pillarKey) {
                case 'journal': startJournal(); break;
                case 'stretch': startStretch(); break;
                case 'strength': startStrength(); break;
                case 'meditate': startMeditation(); break;
            }
        }

        function completePillar(pillarKey) {
            state.pillars[pillarKey].completed = true;
            closeModal();
            saveState();
            updateUI();
        }
        
        function resetDailyProgress() {
            Object.keys(state.pillars).forEach(key => state.pillars[key].completed = false);
            state.journalEntry = '';
            saveState();
        }

        function openModal(content) {
            activityModalContent.innerHTML = content;
            activityModal.classList.remove('hidden');
            setTimeout(() => activityModal.classList.add('visible'), 10); // For transition
            const firstFocusable = activityModalContent.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusable) firstFocusable.focus();
        }

        function closeModal() {
            activityModal.classList.remove('visible');
            setTimeout(() => {
                activityModal.classList.add('hidden');
                activityModalContent.innerHTML = '';
            }, 300);

            if (state.currentTimer) {
                clearInterval(state.currentTimer);
                state.currentTimer = null;
            }
            const mediaElements = activityModal.querySelectorAll('iframe, audio');
            mediaElements.forEach(el => {
                const originalSrc = el.src;
                el.src = '';
                el.src = originalSrc;
            });

            if (state.lastFocusedElement) {
                state.lastFocusedElement.focus();
            }
        }
        
        // --- Pillar Specific Functions ---
        function startJournal() {
            const content = `
                <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-3xl font-light" aria-label="Close dialog">&times;</button>
                <h2 class="text-2xl font-bold mb-4">Daily Journal</h2>
                <div class="flex items-center justify-between mb-6">
                    <p class="text-slate-600 flex-1">${state.currentPrompt}</p>
                    <button onclick="getNewPrompt()" class="ml-4 px-3 py-1 text-sm bg-slate-100 hover:bg-slate-200 rounded-md transition-colors">New Prompt</button>
                </div>
                <textarea id="journal-textarea" class="w-full h-64 border border-slate-300 rounded-md p-4 focus:ring-2 focus:ring-blue-500 resize-none" placeholder="Your thoughts..." style="min-height: 200px;">${state.journalEntry}</textarea>
                <div class="mt-6 flex justify-end">
                    <button onclick="saveJournal()" class="btn-primary px-6 py-2 rounded-md font-semibold">Save & Complete</button>
                </div>
            `;
            openModal(content);
            document.getElementById('journal-textarea').focus();
        }

        function getNewPrompt() {
            const randomIndex = Math.floor(Math.random() * state.journalPrompts.length);
            state.currentPrompt = state.journalPrompts[randomIndex];
            const promptElement = document.querySelector('#activity-modal-content p');
            if (promptElement) {
                promptElement.textContent = state.currentPrompt;
            }
        }

        function saveJournal() {
            const textarea = document.getElementById('journal-textarea');
            state.journalEntry = textarea.value.trim();
            if (state.journalEntry.length > 0) {
                 completePillar('journal');
            } else {
                alert("Please write a little something to complete your journal entry.");
            }
        }

        function startStretch() {
            const content = `
                <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-3xl font-light" aria-label="Close dialog">&times;</button>
                <h2 class="text-2xl font-bold mb-4">10-Minute Full Body Stretch</h2>
                <div class="relative w-full bg-black rounded-lg overflow-hidden mb-4" style="padding-bottom: 56.25%;">
                    <iframe class="absolute top-0 left-0 w-full h-full" src="https://www.youtube.com/embed/g_tea8ZNk5A?autoplay=1&modestbranding=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="completePillar('stretch')" class="btn-primary px-6 py-2 rounded-md font-semibold">Mark as Complete</button>
                </div>
            `;
            openModal(content);
        }

        function startStrength() {
            const singleRound = [];
            state.strengthRoutine.forEach((ex, index) => {
                singleRound.push(ex);
                if (index < state.strengthRoutine.length - 1) {
                    singleRound.push({ name: 'Rest', duration: 5, movement: 'Breathe and prepare for the next exercise.', image: '💧' });
                }
            });
            
            const fullWorkout = [
                ...singleRound,
                { name: 'Mid-Workout Rest', duration: 15, movement: 'Well done! Prepare for Round 2.', image: '🏆' },
                ...singleRound
            ];

            state.currentSequence = fullWorkout;
            runExerciseSequence('strength', '14-Minute Full Body');
        }

        function runExerciseSequence(pillarKey, title) {
            state.currentExerciseIndex = 0;
            showCurrentExercise(pillarKey, title);
        }

        function showCurrentExercise(pillarKey, title) {
            if (state.currentExerciseIndex >= state.currentSequence.length) {
                completePillar(pillarKey);
                return;
            }

            const exercise = state.currentSequence[state.currentExerciseIndex];
            let timeLeft = exercise.duration;
            const radius = 60;
            const circumference = 2 * Math.PI * radius;

            const content = `
                <button onclick="closeModal()" class="absolute top-2 right-2 text-slate-400 hover:text-slate-600 text-2xl font-light" aria-label="Close dialog">&times;</button>
                <div class="text-center">
                    <p class="text-xs font-semibold text-blue-600 uppercase">${title}</p>
                    <h2 class="text-xl sm:text-2xl font-bold mt-1 mb-1">${exercise.name}</h2>
                    <div class="w-full h-20 sm:h-24 flex items-center justify-center my-1 sm:my-2 text-4xl sm:text-6xl">
                        ${exercise.image}
                    </div>
                    <p class="text-slate-500 mb-2 h-6 sm:h-8 text-xs sm:text-sm">${exercise.movement}</p>
                    
                    <div class="relative w-24 h-24 sm:w-28 sm:h-28 mx-auto mb-2 sm:mb-3">
                        <svg class="w-full h-full progress-circle" viewBox="0 0 140 140">
                            <circle class="text-slate-200" stroke-width="10" stroke="currentColor" fill="transparent" r="${radius}" cx="70" cy="70"/>
                            <circle id="progress-bar" class="text-blue-600 progress-circle-bar" stroke-width="10" stroke-dasharray="${circumference}" stroke-dashoffset="0" stroke-linecap="round" stroke="currentColor" fill="transparent" r="${radius}" cx="70" cy="70"/>
                        </svg>
                        <div id="timer-display" class="absolute inset-0 flex items-center justify-center text-2xl sm:text-3xl font-bold text-slate-800">${timeLeft}</div>
                    </div>

                    <p class="text-slate-500 mb-2 text-xs">Next: ${state.currentSequence[state.currentExerciseIndex + 1] ? state.currentSequence[state.currentExerciseIndex + 1].name : 'Finish'}</p>

                    <div class="flex items-center justify-center gap-2 sm:gap-4">
                        <button onclick="previousExercise('${pillarKey}', '${title}')" class="text-slate-400 hover:text-slate-600 transition-colors p-1 rounded-full" aria-label="Previous exercise">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <button onclick="skipExercise('${pillarKey}', '${title}')" class="text-slate-400 hover:text-slate-600 transition-colors p-1 rounded-full" aria-label="Next exercise">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            openModal(content);

            const timerDisplay = document.getElementById('timer-display');
            const progressBar = document.getElementById('progress-bar');
            
            if (state.currentTimer) clearInterval(state.currentTimer);

            state.currentTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                const progress = (exercise.duration - timeLeft) / exercise.duration;
                progressBar.style.strokeDashoffset = circumference * (1 - progress);

                if (timeLeft <= 0) {
                    clearInterval(state.currentTimer);
                    state.currentExerciseIndex++;
                    showCurrentExercise(pillarKey, title);
                }
            }, 1000);
        }

        function skipExercise(pillarKey, title) {
            if (state.currentTimer) clearInterval(state.currentTimer);
            state.currentExerciseIndex++;
            showCurrentExercise(pillarKey, title);
        }

        function previousExercise(pillarKey, title) {
            if (state.currentTimer) clearInterval(state.currentTimer);
            if (state.currentExerciseIndex > 0) {
                state.currentExerciseIndex--;
                showCurrentExercise(pillarKey, title);
            }
        }

        function startMeditation() {
            const content = `
                <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-3xl font-light" aria-label="Close dialog">&times;</button>
                <div class="text-center">
                    <h2 class="text-2xl font-bold mb-4">Preparing for Meditation</h2>
                    <p class="text-slate-600 mb-4 sm:mb-6">Get comfortable. The session will begin shortly.</p>
                    <div id="countdown-display" class="text-6xl sm:text-8xl font-bold text-blue-600">3</div>
                </div>
            `;
            openModal(content);

            let countdown = 3;
            const countdownDisplay = document.getElementById('countdown-display');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownDisplay.textContent = countdown;
                } else {
                    clearInterval(countdownInterval);
                    runMeditation();
                }
            }, 1000);
        }

        function runMeditation() {
            let timeLeft = 12 * 60;
            const startSound = new Audio('https://cdn.pixabay.com/download/audio/2021/08/04/audio_bb630cc098.mp3');
            const endSound = new Audio('https://cdn.pixabay.com/download/audio/2022/03/10/audio_c3b9c0b5b3.mp3');
            
            const content = `
                <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-3xl font-light" aria-label="Close dialog">&times;</button>
                <div class="text-center">
                    <h2 class="text-2xl font-bold mb-4">12-Minute Meditation</h2>
                    <p class="text-slate-600 mb-4 sm:mb-6">Breathe deeply. The session will end with a chime.</p>
                    <div class="relative w-32 h-32 sm:w-40 sm:h-40 md:w-48 md:h-48 mx-auto mb-4 sm:mb-6">
                        <div class="animate-pulse absolute inset-0 bg-blue-100 rounded-full"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                             <div id="timer-display" class="text-2xl sm:text-3xl md:text-4xl font-bold text-slate-800">12:00</div>
                        </div>
                    </div>
                </div>
            `;
            openModal(content);
            startSound.play().catch(e => console.error("Audio play failed:", e));
            
            const timerDisplay = document.getElementById('timer-display');
            if (state.currentTimer) clearInterval(state.currentTimer);
            
            state.currentTimer = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                if (timeLeft <= 0) {
                    clearInterval(state.currentTimer);
                    endSound.play().catch(e => console.error("Audio play failed:", e));
                    setTimeout(() => completePillar('meditate'), 1500);
                }
            }, 1000);
        }
        
        // --- Utility & Accessibility Functions ---
        function updateDynamicGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) {
                dynamicGreeting.textContent = 'Good Morning.';
            } else if (hour < 18) {
                dynamicGreeting.textContent = 'Good Afternoon.';
            } else {
                dynamicGreeting.textContent = 'Good Evening.';
            }
        }

        function addKeyboardListeners() {
            document.addEventListener('keydown', (e) => {
                // Allow activating cards with Enter/Space
                if ((e.key === 'Enter' || e.key === ' ') && document.activeElement.classList.contains('pillar-card')) {
                    e.preventDefault();
                    document.activeElement.click();
                }
                // Allow closing modal with Escape
                if (e.key === 'Escape' && !activityModal.classList.contains('hidden')) {
                    closeModal();
                }
            });
        }

        // --- Local Storage Persistence ---
        function saveState() {
            try {
                localStorage.setItem('pillarAppState', JSON.stringify(state));
            } catch (e) {
                console.error("Failed to save state to localStorage:", e);
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('pillarAppState');
                if (savedState) {
                    const loaded = JSON.parse(savedState);
                    if (loaded.pillars) {
                        state.pillars = loaded.pillars;
                    }
                    state.journalEntry = loaded.journalEntry || '';
                }
            } catch (e) {
                console.error("Failed to load state from localStorage:", e);
            }
        }



        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
